# Task Quality Assessment

Plans generated by users or LLMs often lack sufficient detail for implementation. The coordinator assesses each task
before developer assignment and spawns business analyst agents to expand underspecified tasks.

## Quality Criteria

A task is **implementable** when ALL criteria are present:

| Criterion               | Description                          | Sufficient                         | Insufficient            |
|-------------------------|--------------------------------------|------------------------------------|-------------------------|
| **Clear Scope**         | Specific deliverable with boundaries | "Add rate limiting to /api/users"  | "Improve API security"  |
| **Acceptance Criteria** | Verifiable completion conditions     | "Returns 429 after 100 req/min"    | "Should be fast"        |
| **Target Location**     | Files/modules identifiable           | "Modify src/api/users.py"          | "Update the backend"    |
| **Technical Approach**  | Strategy determinable from context   | "Use token bucket algorithm"       | "Add some limiting"     |
| **Dependencies Clear**  | Required interfaces known            | "Uses RateLimiter from src/common" | "Integrate with system" |

## Task Classification

| Classification        | Definition                                   | Action                                        |
|-----------------------|----------------------------------------------|-----------------------------------------------|
| `IMPLEMENTABLE`       | All criteria met                             | Add to `available_tasks`, ready for developer |
| `NEEDS_EXPANSION`     | Missing 1-2 criteria inferable from codebase | Spawn business analyst agent                  |
| `NEEDS_CLARIFICATION` | Missing criteria requiring user input        | Divine intervention                           |

## Assessment Procedure

After loading the plan and before dispatching developers:

1. **Scan each task** for the quality criteria
2. **Classify** into IMPLEMENTABLE, NEEDS_EXPANSION, or NEEDS_CLARIFICATION
3. **For NEEDS_EXPANSION**: Spawn business analyst agent
4. **For NEEDS_CLARIFICATION**: Use divine intervention protocol

## Assessment Output Format

```
TASK QUALITY ASSESSMENT

Implementable: [N] tasks
- task-1: Clear scope, acceptance criteria, target files identified
- task-4: Implementation path determinable from existing patterns

Needs Expansion: [N] tasks (spawning business analysts)
- task-2: Missing acceptance criteria, target files unclear
- task-5: Technical approach not specified

Needs Clarification: [N] tasks (divine intervention required)
- task-3: Scope ambiguous, multiple valid interpretations
- task-6: Conflicts with existing functionality
```

## Business Analyst Agent

### When to Spawn

Spawn a business analyst when a task is classified as `NEEDS_EXPANSION`.

### Agent Configuration

```
Task tool parameters:
  model: sonnet
  subagent_type: "general-purpose"
  description: "Expand task [task_id]"
```

### Business Analyst Prompt

```
You are a Business Analyst expanding an underspecified task into an implementable specification.

TASK TO EXPAND:
Task ID: {{task_id}}
Original Description: {{task_description}}
Original Acceptance Criteria: {{acceptance_criteria | default: "None specified"}}

CONTEXT FROM PLAN:
{{plan_context}}

---

EXPANSION REQUIREMENTS:
Ground your expansion in:
1. Information explicitly stated in the plan
2. Patterns and conventions discovered in the codebase
3. Logical inference from the above (clearly mark inferences)

CODEBASE ANALYSIS (required before expanding):
Use Glob and Grep to discover:
- Similar implementations in the codebase
- Target files/modules to modify
- Available utilities and interfaces
- Testing patterns to follow

OUTPUT FORMAT:

EXPANDED_TASK_SPECIFICATION
Task: {{task_id}}
Confidence: [HIGH | MEDIUM | LOW]

Summary: [1-2 sentence description]

Scope:
- [Specific deliverable 1]
- [Specific deliverable 2]

Target Files:
- [file path]: [what changes]

Technical Approach:
[Step-by-step implementation strategy based on codebase patterns]

Acceptance Criteria:
- [ ] [Verifiable criterion with command/test]

Dependencies:
- [Module/interface this depends on]

Assumptions (require validation):
- [Any assumptions made]

---

CONFIDENCE LEVELS:
- HIGH: All from plan or codebase, no assumptions
- MEDIUM: Reasonable logical inference required
- LOW: Significant assumptions or multiple valid interpretations

If LOW confidence, explain what clarification would raise it.
```

## Handling Expansion Results

### HIGH/MEDIUM Confidence

1. Store expanded specification in `expanded_tasks` state field
2. Mark task as `IMPLEMENTABLE`
3. Add to `available_tasks`
4. Log event: `task_expanded` with `task_id`, `confidence`, `expansion_summary`

### LOW Confidence

1. Extract clarification questions from BA output
2. Add to `pending_divine_questions`
3. Keep task in `pending_expansions` with status "awaiting-clarification"
4. Log event: `expansion_needs_clarification` with `task_id`, `questions`, `options`
5. Invoke divine intervention protocol

## Expansion Complete Output Format

```
TASK EXPANSION COMPLETE

Expanded successfully: [N] tasks
- task-2: HIGH confidence - rate limiting implementation clear
- task-5: MEDIUM confidence - assumed REST endpoint pattern

Required divine clarification: [N] tasks
- task-7: Multiple valid approaches, asking God for direction

Ready to proceed with [N] implementable tasks.
```

## Workflow Integration

Task quality assessment runs at:

1. **Initial plan load**: Assess all tasks before development begins
2. **Full plan reload** (every second compaction): Re-assess tasks not yet started
3. **New task discovery**: Assess dynamically added tasks

**Critical Rule:** The coordinator must NOT dispatch developers for tasks classified as `NEEDS_EXPANSION` or
`NEEDS_CLARIFICATION`. Only `IMPLEMENTABLE` tasks enter the `available_tasks` queue.

## State Fields

| Field                      | Type   | Description                            |
|----------------------------|--------|----------------------------------------|
| `task_quality_assessed`    | bool   | Whether initial assessment complete    |
| `pending_expansions`       | object | Maps task_id to BA agent_id            |
| `active_business_analysts` | object | Maps BA agent_id to task_id            |
| `expanded_tasks`           | object | Maps task_id to expanded specification |

## Events

| Event                           | Trigger              | Fields                                                                      |
|---------------------------------|----------------------|-----------------------------------------------------------------------------|
| `task_quality_assessment`       | Assessment complete  | `implementable_count`, `needs_expansion_count`, `needs_clarification_count` |
| `business_analyst_dispatched`   | BA spawned           | `task_id`, `agent_id`, `missing_criteria`                                   |
| `task_expanded`                 | BA completed         | `task_id`, `confidence`, `expansion_summary`                                |
| `expansion_needs_clarification` | BA needs divine help | `task_id`, `questions`, `options`                                           |
